#!/bin/sh -efu

arch="$1"; shift

. gb-sh-functions
. gb-sh-tmpdir

Q='%{NAME}\t%|EPOCH?{%{EPOCH}:}|%{VERSION}-%{RELEASE}\t%{ARCH}\t%{SOURCERPM}\n'
for i in $(build_nums); do
	[ -d "build/$i/$arch/rpms" ] || continue
	find "build/$i/$arch/rpms" -mindepth 1 -maxdepth 1 -type f -execdir \
		rpmquery --qf "$Q" -p -- '{}' '+'
done >"$tmpdir"/packages

cd "$tmpdir"
dups1 packages >dups

if [ -s dups ]; then
	echo "	$arch: duplicate packages:"
	cat dups
	exit 1
fi >&2
