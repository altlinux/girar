#!/bin/sh -efu

arch="$1"; shift

. gb-sh-functions
. gb-sh-tmpdir

Q='%{NAME}\t%|EPOCH?{%{EPOCH}:}|%{VERSION}-%{RELEASE}\t%{ARCH}\t%{SOURCERPM}\n'
set +f
rpmquery --qf "$Q" -p build/*/$arch/rpms/*.rpm >"$tmpdir"/$arch-pkg.all
set -f

cd "$tmpdir"

sort -u -k1,1 -k2,2 -k3,3 -k4,4 -o $arch-pkg.all{,}
sort -u -k1,1 <$arch-pkg.all >$arch-pkg.uniq

if ! diff -U1 $arch-pkg.{all,uniq}; then
	stamp_echo >&2 "[$arch] non-unique set of packages"
	exit 1
fi
