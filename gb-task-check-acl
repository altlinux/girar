#!/bin/sh -efu

. gb-sh-functions
. gb-sh-repo-conf

[ -z "${PATH##/usr/libexec/girar:*}" -o -z "${PATH%%*:/usr/libexec/girar}" ] ||
	PATH="$PATH:/usr/libexec/girar"

rc=0

check_acl()
{
	local u="$1" src="$2"; shift 2
	if ! out=$(GIRAR_USER="$u" girar-check-perms "$src" "$GB_REPO_NAME" 2>&1); then
		echo "$out"
		echo "pkg=$src author=$u repo=$GB_REPO_NAME: ACL check failed"
		rc=1
	fi >&2
}

. gb-sh-tmpdir

# Deal with added packages.
# input: src-N  src-EVR  src-F
cut -f1,3 plan/add-src >$tmpdir/src2srpm
sort -u -o $tmpdir/src2srpm{,}

while read -r N F; do
	i=$(srpm2i "$F")
	u=$(cat gears/$i/tag_userid)
	check_acl "$u" "$N"
done <$tmpdir/src2srpm

# Deal with removed/replaced packages.
# input: src1-N  src2-F
while read -r N F; do
	i=$(srpm2i "$F")
	u=$(cat gears/$i/tag_userid)
	echo >&2 "$N is replaced with $F"
	check_acl "$u" "$N"
done <plan/oldsrc2newsrpm

exit $rc
