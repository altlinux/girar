#!/bin/sh -efu

arch="$1" N="$2" EVR="$3"
shift 3

tmpdir=
cleanup()
{
	trap - EXIT
	[ -z "$tmpdir" ] || rm -rf -- "$tmpdir"
	exit "$@"
}

exit_handler()
{
	cleanup $?
}

signal_handler()
{
	cleanup 1
}

trap exit_handler EXIT
trap signal_handler HUP INT QUIT PIPE TERM

tmpdir=$(mktemp -t -d "${0##*/}.XXXXXXXX")

# Initialize.
setarch "$arch" -- \
hsh --init --pkg-build-list=basesystem,glibc-locales >"$tmpdir"/out 2>&1 ||
	{
		echo "	$arch: initroot failed:"
		cat "$tmpdir"/out
		exit 1
	} >&2

# Check if the package is already installed.
Q='%{name}=%|serial?{%{serial}:}|%{version}-%{release}\n'
setarch "$arch" -- \
hsh-run -- rpmquery -a --qf "$Q" >"$tmpdir"/packages
if fgrep -qs -x -e "$N=$EVR" "$tmpdir"/packages; then
	# The package is already installed.  Since the package is part of
	# basesystem, removing it might not work very well.
	exit 0
fi

# Workaround a problem with apt filelist.
setarch "$arch" -- \
hsh-run --rooter -- \
mkdir -p -m755 /usr/share/man/ru/man1

# Make initial file list.
setarch "$arch" -- \
hsh-run --rooter -- \
find / 2>/dev/null |sort -u >"$tmpdir"/flist1

# Install the package AND apt.
setarch "$arch" -- \
hsh-install -- "$N=$EVR" apt >"$tmpdir"/out 2>&1 ||
	{
		echo "	$arch: $N=$EVR install failed:"
		cat "$tmpdir"/out
		exit 1
	} >&2

# Make post-install file list.
setarch "$arch" -- \
hsh-run --rooter -- \
find / 2>/dev/null |sort -u >"$tmpdir"/flist2

# Check new files.
comm -23 "$tmpdir"/flist{2,1} >"$tmpdir"/new-files

if [ -s "$tmpdir"/new-files ]; then
	cat >"$tmpdir"/ignore-p <<'EOF'
/etc/alternatives/links/.*
/etc/rc\.d/rc[0-6]\.d/[KS][0-9].*
/etc/tcb/.*
/usr/share/mime/.*
/var/cache/fontconfig/.*
/var/cache/gconf/.*
/var/resolv/(lib|lib64)/lib.*
EOF
	if egrep -v -x -f "$tmpdir"/ignore-p -- \
	   "$tmpdir"/new-files >"$tmpdir"/new-files+; then
		mv -f "$tmpdir"/new-files{+,}
	fi
fi

xargs -r --delimiter='\n' <"$tmpdir"/new-files \
setarch "$arch" -- \
hsh-run --rooter -- \
rpmquery --whatprovides -- >/dev/null 2>"$tmpdir"/out ||:

if [ -s "$tmpdir"/out ]; then
	sed -i 's|no package provides \(/.*\)|file \1 is not owned by any package|' "$tmpdir"/out
	echo "	$arch: $N=$EVR post-install filelist check:"
	cat "$tmpdir"/out
fi >&2

# Try to remove the package.
setarch "$arch" -- \
hsh-run --rooter -- \
apt-get remove -qq -y --dry-run "$N=$EVR" >"$tmpdir"/remv 2>&1 ||
	{
		echo "	$arch: $N=$EVR --dry-run uninstall failed:"
		cat "$tmpdir"/remv
		exit 1
	} >&2

# Check if apt is to be removed along with the package.
if grep -qs '^Remv apt ' "$tmpdir"/remv; then
	# Removing apt with apt might not work very well.
	exit 0
fi

# Remove the package.
setarch "$arch" -- \
hsh-run --rooter -- \
apt-get remove -qq -y "$N=$EVR" </dev/null >"$tmpdir"/out 2>&1 ||
	{
		echo "	$arch: $N=$EVR uninstall failed:"
		cat "$tmpdir"/out
		exit 1
	} >&2
