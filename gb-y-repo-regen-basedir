#!/bin/sh -efu

. gb-sh-functions

bloat=
if [ "$1" = '--bloat' ]; then
	bloat=1
	shift
fi

REPO_DIR="$1"
shift

. gb-sh-tmpdir

if [ -n "$bloat" ]; then
	set -- --bloat
else
	for arch in i586 x86_64 noarch; do
		gb-x-useful-files "$REPO_DIR"/$arch/RPMS.classic >"$tmpdir"/useful-files.$arch ||
			echo 1 >>"$tmpdir"/FAIL &
	done
	wait
	if [ -s "$tmpdir"/FAIL ]; then
		exit 1
	fi
	LC_ALL=C sort -m -u -o "$tmpdir"/useful-files -- "$tmpdir"/useful-files.{i586,x86_64,noarch}
	set -- --useful-files="$tmpdir"/useful-files --no-scan
fi

mkdir -p "$HOME"/.cache/gen{pkg,src}list

for arch in i586 x86_64 noarch; do
	genbasedir "$@" \
		--cachedir="$HOME"/.cache \
		--architectures="i586 x86_64 noarch" \
		--architecture="$arch" \
		--archive="ALT Linux $GB_REPO_NAME" \
		--codename="$GB_REPO_CODENAME" \
		--description="ALT Linux $GB_REPO_NAME" \
		--label="$GB_REPO_NAME" \
		--origin="ALT Linux Team" \
		--suite="$GB_REPO_NAME" \
		--version="$GB_REPO_NAME" \
		-s --default-key="$GB_REPO_SIGNER" \
		--topdir="$REPO_DIR" \
		--flat --no-oldhashfile --bz2only --mapi $arch classic ||
			echo 1 >>"$tmpdir"/FAIL &
done
wait
if [ -s "$tmpdir"/FAIL ]; then
	exit 1
fi
