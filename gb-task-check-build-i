#!/bin/sh -efu

. gb-sh-functions

i="$1"; shift

if [ -s "gears/$i/dir" ]; then
	dir="$(cat "gears/$i/dir")"
	I="${dir##*/} $(cat "gears/$i/tag_name")"
else
	I="$(cat "gears/$i/copy_repo") $(cat "gears/$i/package")"
fi

Fatal()
{
	stamp_echo >&2 "$I: $*"
	exit 1
}

cd build/$i

check_srpms()
{
	set +f
	for arch in i586 x86_64; do
		set $arch/srpm/*.src.rpm
		if [ $# -gt 1 ]; then
			Fatal "multiple $arch source packages:" "$@"
		fi
		[ -f "$1" ] ||
			Fatal "no $arch source package"
		echo "${1##*/}"
	done
}

srpms=$(check_srpms)
n=$(echo "$srpms" |sort -u |wc -l)

[ "$n" -eq 1 ] ||
	Fatal 'different per-arch srpms:' $srpms

noarch()
{
	set +f
	local arch="$1"; shift
	(cd $arch/rpms && ls *.noarch.rpm 2>/dev/null) ||:
}

. gb-sh-tmpdir

noarch i586 >"$tmpdir"/i586.noarch
noarch x86_64 >$tmpdir/x86_64.noarch
(cd "$tmpdir" && diff -U1 {i586,x86_64}.noarch ) ||
	Fatal 'different set of noarch packages'

dump_noarch()
{
	F='[%{FILENAMES}\n]'
	R='[Requires: %{REQUIRENAME} %{REQUIREFLAGS:depflags} %{REQUIREVERSION}\n]'
	P='[Provides: %{PROVIDENAME} %{PROVIDEFLAGS:depflags} %{PROVIDEVERSION}\n]'
	O='[Obsoletes: %{OBSOLETENAME} %{OBSOLETEFLAGS:depflags} %{OBSOLETEVERSION}\n]'
	C='[Conflicts: %{CONFLICTNAME} %{CONFLICTFLAGS:depflags} %{CONFLICTVERSION}\n]'
	rpmquery --qf "$F$R$P$O$C" -p "$1"
}

while read -r rpm; do
	dump_noarch i586/rpms/"$rpm" >$tmpdir/$rpm.i586
	dump_noarch x86_64/rpms/"$rpm" >$tmpdir/$rpm.x86_64
	(cd "$tmpdir" && diff -U1 $rpm.{i586,x86_64} ) ||
		Fatal 'noarch packages mismatch'
done <$tmpdir/i586.noarch
