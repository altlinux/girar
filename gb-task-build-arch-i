#!/bin/sh -efu

. shell-quote

arch="$1" i="$2"; shift 2

. gb-sh-functions
. gb-sh-conf

dir=$(cat gears/$i/dir)
tag_name=$(cat gears/$i/tag_name)
tag_author=$(cat gears/$i/tag_author)

I="[$arch] ${dir##*/} $tag_name: build"
stamp_echo >&2 "$I start"

rm -f build/$i/$arch/REBUILD
# rebuild is certainly needed if previous packages have been rebuilt
if [ -s build/$i/$arch/chroot_base ]; then
	for j in `seq 1 $(($i-1))`; do
		if [ -s build/$j/$arch/REBUILD ]; then
			echo 1 >build/$i/$arch/REBUILD
			break
		fi
	done
fi

# copy source package and accompanying build data to remote side
rsync -q -- "gears/$i/pkg.tar" "$remote_host:tmp/"
(umask 002; mkdir -p "build/$i/$arch") || false
touch "build/$i/$arch/log"
rsync -qrlt --delete -- "build/$i/$arch/" "$remote_host:build/"

# run the build on remote side
ssh "$remote_host" ./gb-remote-build \
	"\"$(quote_shell "$arch")\"" \
	"\"$(quote_shell "${dir##*/}")\"" \
	"\"$(quote_shell "$tag_name")\"" \
	"\"$(quote_shell "$tag_author")\"" ||
		{ stamp_echo >&2 "$I FAILED";
		  rsync -q -- "$remote_host:build/*log" "build/$i/$arch/";
		  exit 1; }

# copy build result from remote side
rsync -qrlt --delete -- "$remote_host:build/" "build/$i/$arch/"
find "build/$i/$arch/" -type d -print0 |
	xargs -r0 chmod 775 --

stamp_echo >&2 "$I OK"
