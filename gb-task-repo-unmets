#!/bin/sh -efu

. gb-sh-functions
repo1="$GB_REPO_DIR"

# Reuse our temporary repo.
repo2="$TMPDIR/gb-repo-$GB_REPO_NAME"

. gb-sh-tmpdir
cd "$tmpdir"

# dump old unmets
for arch in i586 x86_64; do
	cat >old-$arch-sources.list <<EOF
rpm file:$repo1 $arch classic
rpm file:$repo1 noarch classic
EOF
	$arch unmets -s old-$arch-sources.list >$arch-unmets.old
done

# dump new unmets
for arch in i586 x86_64; do
	cat >new-$arch-sources.list <<EOF
rpm file:$repo2 $arch classic
rpm file:$repo2 noarch classic
EOF
	$arch unmets -s new-$arch-sources.list >$arch-unmets.new
done

rc=0

# compare unmets
for arch in i586 x86_64; do
	comm -13 $arch-unmets.{old,new} >$arch-unmets.plus
	comm -23 $arch-unmets.{old,new} >$arch-unmets.minus
	if [ -s $arch-unmets.plus ]; then
		echo "	$arch: NEW unmet dependencies detected:"
		awk -F'\t' '{printf "%-24s\t%s\n", $1, $2}' <$arch-unmets.plus
		rc=1
	fi >&2
	if [ -s $arch-unmets.minus ]; then
		echo "	$arch: old unmet dependencies resolved:"
		awk -F'\t' '{printf "%-24s\t%s\n", $1, $2}' <$arch-unmets.minus
	fi >&2
done

[ "$rc" = 0 ] && text=OK || text=FAILED
stamp_echo >&2 "dependencies check $text"
exit $rc
