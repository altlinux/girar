#!/bin/sh -efu

id="$1"; shift

cd "$GIRAR_TASKS/$id"
enable -f /usr/lib/bash/lockf lockf
builtin lockf -v .

(
	umask 002
	exec >>task/log 2>&1
	[ -s task/log ] &&
		echo "Resuming task $id on $(date)" ||
		echo "Starting task $id on $(date)"
	set -x
	gb-task-pkgtar
	gb-task-build
	gb-task-check-build
	gb-task-repo-plan
	gb-task-repo-vercheck
	gb-task-repo-unmets
	gb-task-check-acl
)

rc=$?

seq=$(cat task/seq)
seq=$(($seq+1))
echo "$seq" >task/seq

mutt -x -s "task=$id rc=$rc" -a task/log "$(cat task/owner)"@altlinux.org

# for girar-builder
echo >&2 rc=$rc
