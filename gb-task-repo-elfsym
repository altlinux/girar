#!/bin/sh -efu

# This check does not apply to noarch packages.
cut -f3 plan/{add,rm}-bin |fgrep -qs -v noarch || exit 0

. gb-sh-functions
repo1="$GB_REPO_DIR"

# Reuse temporary repo created by gb-task-repo-unmets.
repo2="$TMPDIR/gb-repo-$GB_REPO_NAME"

. gb-sh-tmpdir
cd "$tmpdir"

rc=0

for arch in i586 x86_64; do
	bad_elf_symbols.pl "$repo1"/files/$arch/RPMS >$arch-bes.old
	bad_elf_symbols.pl "$repo2"/files/$arch/RPMS >$arch-bes.new
	sort -u -o $arch-bes.old{,}
	sort -u -o $arch-bes.new{,}
	comm -13 $arch-bes.{old,new} >$arch-bes.plus
	comm -23 $arch-bes.{old,new} >$arch-bes.minus
	if [ -s $arch-bes.plus ]; then
		echo "	$arch: NEW bad_elf_symbols detected:"
		cat $arch-bes.plus
		rc=1
	fi >&2
	if [ -s $arch-bes.minus ]; then
		echo "	$arch: old bad_elf_symbols resolved:"
		cat $arch-bes.minus
	fi >&2
done

[ "$rc" = 0 ] && text=OK || text=FAILED
stamp_echo >&2 "ELF symbols check $text"
exit $rc
