#!/bin/sh -efu

. gb-sh-conf

cd "$GB_TASKS_DIR"

repo_tasks()
{
	set +f
	fgrep -l -i -x "$GB_REPO_NAME" [1-9]*/task/repo |
	cut -d/ -f1 |sort -n
}

enable -f /usr/lib/bash/lockf lockf

select_task()
{
	local id="$1"; shift
	cd "$id"
	# obtain an exclusive lock on the TASKS structure
	# if the lock cannot be immediately acquired, fail
	builtin lockf -n .

	# if task sequence number is not set, fail
	[ -s task/seq ]

	local seq
	seq=$(cat task/seq)
	# if the task is not ready to run, fail
	[ -n "$seq" ]
	[ "$(($seq%3))" -eq 0 ]

	seq=$(($seq+1))
	echo "$seq" >task/seq
}

for id in $(repo_tasks); do
	(select_task "$id")
	if [ $? -eq 0 ]; then
		echo "$id"
		exit
	fi
done
