#!/bin/sh -efu

. gb-sh-functions

fail_if_task_abort_requested

while read -r i N; do
	list_notifiable_pkg_acl_members "$N"
done < plan/check_acl >> report/acl-addressees
sort -u -o report/acl-addressees{,}

id=$(cat task/id)
gb-x-girar check-task-perms "$id" && rc=0 || rc=1


if [ "$rc" = 0 ]; then
	stamp_echo >&2 'acl check OK'
else
	stamp_echo >&2 'acl check FAILED'
	gb-x-girar task-change-state "$id" EPERM
fi

exit $rc
