#!/bin/sh -efu

. gb-sh-functions

fail_if_task_abort_requested

force_rebuild=
# find the first failed subtask
for arch in $GB_ARCH; do
	[ -s "build/force-rebuild-$arch" ] ||
		continue

	force_rebuild_arch="$(cat build/force-rebuild-"$arch")"
	if [ -z "$force_rebuild" ] ||
	   [ "$force_rebuild_arch" -lt "$force_rebuild" ]; then
		force_rebuild="$force_rebuild_arch"
	fi

	rm -f "build/force-rebuild-$arch"
done

[ -n "$force_rebuild" ] ||
	exit 0

is_rebuild_needed()
{
	local arch total_arch= found_arch= this_ti= prev_ti
	for arch in $GB_ARCH; do
		total_arch="$total_arch $arch"
		prev_ti="$this_ti"

		this_ti="build/$i/$arch/try_iter"
		[ -f "$this_ti" ] ||
			continue

		found_arch="$found_arch $arch"

		[ -n "$prev_ti" ] ||
			continue

		cmp -s "$prev_ti" "$this_ti" ||
			return 0
	done

	[ -n "$found_arch" ] && [ "$found_arch" != "$total_arch" ]
}

for i in $(src_nums); do
	if [ "$i" -ge "$force_rebuild" ] && is_rebuild_needed; then
		stamp_echo >&2 "#$i: force rebuild"
		rm -rf "build/$i"
	fi
done
