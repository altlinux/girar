#!/bin/sh -efu

. gb-sh-functions

commit()
{
	local arch_all
	while read -r N EVR A F; do
		RM $GB_REPO_DIR/$A/RPMS.classic/$F
		RM $GB_REPO_DIR/files/$A/RPMS/$F
	done <plan/rm-bin
	while read -r N EVR A F; do
		bin=$(findbin "$F")
		CP "$bin" $GB_REPO_DIR/files/$A/RPMS/$F
		LN ../../files/$A/RPMS/$F $GB_REPO_DIR/$A/RPMS.classic/$F
	done <plan/add-bin

	while read -r F A; do
		RM $GB_REPO_DIR/$A/SRPMS.classic/$F
		if [ "$A" = 'noarch' ]; then
			arch_all='i586 x86_64'
		else
			arch_all="$A"
		fi
		for arch in $arch_all; do
			if [ -e "$GB_REPO_DIR/$arch/SRPMS.all/$F" ]; then
				RM "$GB_REPO_DIR/$arch/SRPMS.all/$F"
			fi
		done
	done <plan/rm-srpm2arch
	while read -r N EVR F; do
		RM $GB_REPO_DIR/files/SRPMS/$F
	done <plan/rm-src

	while read -r N EVR F; do
		src=$(findsrc "$F")
		CP "$src" $GB_REPO_DIR/files/SRPMS/$F
	done <plan/add-src
	while read -r F A; do
		LN ../../files/SRPMS/$F $GB_REPO_DIR/$A/SRPMS.classic/$F
		if [ "$A" = 'noarch' ]; then
			arch_all='i586 x86_64'
		else
			arch_all="$A"
		fi
		for arch in $arch_all; do
			[ -e "$GB_REPO_DIR/$arch/SRPMS.all/$F" ] ||
				LN "../../files/SRPMS/$F" "$GB_REPO_DIR/$arch/SRPMS.all/$F"
		done
	done <plan/add-srpm2arch
}

RM()
{
	if ! [ -f "$1" ]; then
		echo "$1: file not found"
		return 1
	fi >&2
}

CP()
{
	if [ -e "$2" ] || [ -L "$2" ]; then
		echo "$2: file already exists"
		return 1
	fi >&2
}

LN()
{
	if [ -e "$2" ] || [ -L "$2" ]; then
		echo "$2: file already exists"
		return 1
	fi >&2
}

# test commit
commit

RM()
{
	rm -v "$1"
}

CP()
{
	cp -v -l "$1" "$2"
}

LN()
{
	ln -v -s "$1" "$2"
	if ! [ -f "$2" ]; then
		echo "$2: created dangling symlink"
		rm -v "$2"
		return 1
	fi >&2
}

# real commit
commit

# update lists
install -pm644 -- plan/next.src "$GB_REPO_DIR/files/list/src.list"
install -pm644 -- plan/next.bin "$GB_REPO_DIR/files/list/bin.list"

stamp_echo >&2 'packages update OK'

. gb-sh-tmpdir

for arch in i586 x86_64 noarch; do
	genbasedir \
		--architectures="i586 x86_64 noarch" \
		--architecture="$arch" \
		--archive="ALT Linux $GB_REPO_NAME" \
		--codename="$GB_REPO_CODENAME" \
		--description="ALT Linux $GB_REPO_NAME" \
		--label="$GB_REPO_NAME" \
		--origin="ALT Linux Team" \
		--suite="$GB_REPO_NAME" \
		--version="$GB_REPO_NAME" \
		-s --default-key="$GB_REPO_SIGNER" \
		--topdir="$GB_REPO_DIR" \
		--flat --no-oldhashfile --bz2only --mapi $arch classic
	stamp_echo >&2 "[$arch] genbasedir OK"
	sisyphus_gen_contents $GB_REPO_DIR/$arch/RPMS.classic >$tmpdir/contents_index
	cmp -s $tmpdir/contents_index $GB_REPO_DIR/$arch/base/contents_index ||
		mv -f $tmpdir/contents_index $GB_REPO_DIR/$arch/base/contents_index
	stamp_echo >&2 "[$arch] gencontents OK"
done
stamp_echo >&2 'indices update OK'
