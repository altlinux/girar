#!/bin/sh -efu

PROG="${0##*/}"
giter_queue="@GITER_PUBLIC_QUEUE@"
private_queue="@GITER_PRIVATE_QUEUE@"
upravdom_queue="@UPRAVDOM_QUEUE@"
upravdom_account="@UPRAVDOM_ACCOUNT@"

selflock="$private_queue/.lock"
giterlock="$giter_queue/.lock"
upravdomlock="$upravdom_queue/.lock"

error() {
	printf %s\\n "$PROG: ERROR: [$(date +"%Y-%m-%d %T")]: $*" >&2
}

fatal() {
	error "$*"
	exit 1
}

exit_handler() {
	local rc=$?
	trap - EXIT

	[ ! -d "$giterlock" -o ! -O "$giterlock" ] || rmdir -- "$giterlock"

	ssh -n "$upravdom_account" "[ ! -d '$upravdomlock' -o ! -O '$upravdomlock' ] || rmdir -- '$upravdomlock'" ||
		error "$upravdom_account: $upravdomlock: unable to remove lockdir"

	[ ! -d "$selflock" ] || rmdir -- "$selflock"

	exit $rc
}

find_args="-mindepth 1 -maxdepth 1 -regextype posix-basic -regex '^.*/[[:digit:]]\+$' -type f -printf '%f\n'"

findin() {
	eval find "\$1" $find_args | sort -n
}

findin_upravdom_queue() {
	ssh -n "$upravdom_account" "find '$upravdom_queue' $find_args" | sort -n
}

trap exit_handler HUP PIPE INT QUIT TERM EXIT

mkdir -- "$selflock" >/dev/null 2>&1 || exit 0

while ! mkdir -- "$giterlock" >/dev/null 2>&1; do
	sleep 1
done

private_num="$(findin "$private_queue" |tail -1)"

[ -n "$private_num" ] &&
    private_num=$(($private_num+1)) ||
    private_num=0

for name in $(findin "$giter_queue"); do
	task="$giter_queue/$name"

	if [ ! -s "$task" ]; then
		rm -f -- "$task"
		continue
	fi

	if ! mv -- "$task" "$private_queue/$private_num"; then
		error "unable to move '$task' -> '$private_queue/$private_num'"
		continue
	fi

	private_num=$(($private_num+1))
done

rmdir -- "$giterlock"

ssh -n "$upravdom_account" "while ! mkdir -- '$upravdomlock'>/dev/null 2>&1; do sleep 1; done" ||
	fatal "unable to lock upravdom queue"

upravdom_num="$(findin_upravdom_queue |tail -1)"

[ -n "$upravdom_num" ] && 
	upravdom_num=$(($upravdom_num+1)) ||
	upravdom_num=0

for name in $(findin "$private_queue"); do
	rsync -tp "$private_queue/$name" "$upravdom_account:$upravdom_queue/$upravdom_num" ||
		fatal "unable to forward task '$private_queue/$name' -> '$upravdom_account:$upravdom_queue/$upravdom_num': rc=$?"
	rm -f -- "$task"
	upravdom_num=$(($upravdom_num+1))
done
