#!/bin/sh -efu

PROG=git-mv-db

fatal()
{
	echo "$PROG: $*" >&2
	exit 1
}

usage()
{
	echo "$PROG: $*" >&2
	echo "usage: $PROG <source-directory> <dest-directory>" >&2
	exit 1
}

[ "$#" -ge 2 ] ||
	usage 'Not enough arguments.'
[ "$#" -eq 2 ] ||
	usage 'Too many arguments.'

cd "$HOME/packages"

srcdir0="$1" && shift
srcdir="$(printf %s "$srcdir0" |sed -e 's,^packages/,,' -e 's,/\+$,,' -e 's,\.git$,,')"
printf %s "$srcdir" |egrep -qs '^[A-Za-z0-9][-A-Za-z0-9_.]+$' ||
	fatal "$srcdir0: invalid source directory name"

dstdir0="$1" && shift
dstdir="$(printf %s "$dstdir0" |sed -e 's,^packages/,,' -e 's,/\+$,,' -e 's,\.git$,,')"
printf %s "$dstdir" |egrep -qs '^[A-Za-z0-9][-A-Za-z0-9_.]+$' ||
	fatal "$dstdir0: invalid destination directory name"

[ -d "$srcdir.git" ] ||
	fatal "$srcdir0: source directory not available"
[ ! -e "$dstdir.git" ] ||
	fatal "$dstdir0: destination directory already exists"

cd "$srcdir.git"
cd "$HOME/packages"
mkdir -- "$dstdir.git"
mv -T -- "$srcdir.git" "$dstdir.git"
