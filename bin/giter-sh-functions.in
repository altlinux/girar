#!/bin/sh

PROG="${PROG:-${0##*/}}"
project_name_regexp='^[A-Za-z0-9][-A-Za-z0-9_.]+$'

error()
{
	echo "$PROG: $*" >&2
}

fatal()
{
	error "$*"
	exit 1
}

quote_sed_regexp()
{
	local out="$*"
	if [ -z "${out##*[\[\].^\$\\/]*}" ]; then
		out="$(printf %s "$out" |sed -e 's/[].^$[\/]/\\&/g')" ||
			return 1
	fi
	printf %s "$out"
}

validate_packages_dir()
{
	local dir0 dirname dir
	dir0="$1" && shift
	dirname="${dir0%/*}"
	[ "$dirname" = "packages" -o "$dirname" = "private" ] ||
		fatal "$dir0: invalid directory name"
	dir="$(printf %s "$dir0" |sed -e 's,^packages/,,' -e 's,^private/,,' -e 's,/\+$,,' -e 's,\.git$,,')"
	printf %s "$dir" |egrep -qs "$project_name_regexp" ||
		fatal "$dir0: invalid directory name"
	printf %s\\n "$dirname/$dir"
}
