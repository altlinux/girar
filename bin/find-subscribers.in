#!/bin/ash -eu

PROG="${0##*/}"

# env: GITER_USER_PREFIX GITER_USER GIT_DIR
GITER_USER_PREFIX=${GITER_USER_PREFIX:?}
GITER_USER=${GITER_USER:?}
GIT_DIR=${GIT_DIR:?}

# Globals
git_aliases=/etc/postfix/git.aliases
maildir="@GITER_EMAIL_DIR@/packages"

# Arguments
project_name=
ref_style=
ref_name=

# quote argument for sed regexp.
quote_sed_regexp()
{
	local out="$*"
	if [ -z "${out##*[\[\].^\$\\/]*}" ]; then
		out="$(printf %s "$out" |sed -e 's/[].^$[\/]/\\&/g')" ||
			return
	fi
	printf %s "$out"
}

translate_email()
{
	local a=
	while read a; do 
	    	a="$(quote_sed_regexp "$a")"
		sed -ne "s/^${GITER_USER_PREFIX}$a:[[:space:]]\\+\\([^[:space:]]\\+\\).*/\\1/p" "$git_aliases"
	done
}


find_subscribers()
{
	if [ "$project_type" != packages ]; then
		cat "$GIT_DIR/mailto" 2>/dev/null
		return
	fi

	local u="$(quote_sed_regexp "$GITER_USER")"
	local p="$project_name"
	local t="$ref_style"
	local n="$ref_name"

	u="\\(\\*\\|$u\\)"
	p="\\(\\*\\|$p\\)"
	t="\\(\\*\\|$t\\)"
	n="\\(\\*\\|$n\\)"

	grep -ls "^$u[[:space:]]\\+$p[[:space:]]\\+$t[[:space:]]\\+$n[[:space:]]*\$" "$maildir"/*/subscription |
		sed -ne "s|^$maildir/\\([^/]\\+\\)/subscription\$|\\1|p"

	[ ! -f "$maildir/$u/distribution" ] ||
		sed -ne "s/^$p[[:space:]]\\+$t[[:space:]]\\+$n[[:space:]]\\+//p" "$maildir/$u/distribution" |
		tr -s ',[:space:]' '\n'
}

if [ "$#" -ne 3 ]; then
    	printf %s\\n "$PROG: Wrong number of arguments: $#" >&2
    	exit 1
fi

project_name="$(quote_sed_regexp "$1")" && shift
ref_style="$(quote_sed_regexp "$1")" && shift
ref_name=="$(quote_sed_regexp "$1")" && shift

find_subscribers |
	translate_email |
	sed -e '/^[[:space:]]*$/d' -e 's/^[[:space:]]\+//' -e 's/[[:space:]]\+$//' |
	sort -u
