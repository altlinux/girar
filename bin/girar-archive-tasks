#!/bin/sh -efu

. girar-sh-functions

enable -f /usr/lib/bash/lockf lockf
builtin lockf .

cd "$GB_TASKS"

task_type()
{
	local n="$1"; shift
	local seq
	seq="$(cat -- "$n/task/seq" 2>/dev/null ||:)"
	[ -n "$seq" ] && [ "$seq" -ge 0 ] 2>/dev/null || {
		echo new
		return
	}

	case "$(($seq%3))" in
		# awaiting for build
		0) echo awaiting ;;
		# work in progress
		1) echo building ;;
		# have build results
		2)
		[ 0 = "$(cat -- "$n/task/rc" 2>/dev/null)" ] &&
			echo done ||
			echo failed
		;;
	esac
}

rotate()
{
	local n="$1"; shift
	local seq
	seq="$(task_type "$n")"
	mkdir -p "archive/$seq"
	mv -- "$n" "archive/$seq/"
}


find . -mindepth 2 -maxdepth 2 -path './[1-9]*/task' -type d -mtime +5 |
  cut -d/ -f2 |sort -rn |while read n; do
	rotate "$n"	
done
