#!/bin/sh -efu

[ "$#" -eq 0 ] || exit 1

. girar-sh-config

girar_queue="$GIRAR_PUBLIC_QUEUE"

enable -f /usr/lib/bash/lockf lockf
builtin lockf -v "$girar_queue"

num="$(find "$girar_queue" -mindepth 1 -maxdepth 1 -regextype posix-basic -regex '^.*/[[:digit:]]\+$' -type f -printf '%f\n' |
       sort -n |tail -1)"

[ -n "$num" ] &&
	num=$(($num+1)) ||
	num=0

cat >"$girar_queue/$num"
echo >&2 "Queued #$num"
