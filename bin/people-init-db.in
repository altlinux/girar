#!/bin/sh -efu

PROG=people-init-db

fatal()
{
	echo "$PROG: $*" >&2
	exit 1
}

usage()
{
	echo "$PROG: $*" >&2
	echo "usage: $PROG <directory>" >&2
	exit 1
}

[ "$#" -ge 1 ] ||
	usage 'Not enough arguments.'
[ "$#" -eq 1 ] ||
	usage 'Too many arguments.'

cd "$HOME/packages"

dir0="$1" && shift
dir="$(printf %s "$dir0" |sed -e 's,^packages/,,' -e 's,/\+$,,' -e 's,\.git$,,')"
printf %s "$dir" |egrep -qs '^[A-Za-z0-9][-A-Za-z0-9_.]+$' ||
	fatal "$dir0: invalid directory name"
mkdir -- "$dir.git"
cd "$dir.git"
GIT_DIR=. git-init-db --template=@GITER_TEMPLATES_DIR@
echo "packages/$dir" >description
install -m600 -- /dev/null git-daemon-export-ok
