#!/bin/sh -efu

read line
set -- $line
unset line

. shell-error
. girar-sh-config

usage()
{
	[ -z "$*" ] || message "$*"
	echo >&2 "usage: $PROG <reponame> <taskno>"
	exit 1
}

[ $# -ge 2 ] || usage 'Not enough arguments.'
[ $# -le 2 ] || usage 'Too many arguments.'
logger -t "$PROG" "$*"

repo="$1"; shift
task="$1"; shift

[ "$task" -gt 0 ] 2>/dev/null || fatal "task $task: Invalid argument"

src="$repo/release/$task"
dst="$repo/task/$task"
k="_$(($task/1024))"
adst="$repo/task/archive/$k/$task"

cd "$STATE_DIR/repo"

if [ -e "$dst" -o -e "$adst" ]; then
	fatal "task $task: Task already reposited"
fi
[ -d "$src" ] ||
	fatal "task $task: Task not ready"

for d in $(set +f && echo ??*); do
	[ "$repo" = "$d" ] || continue
	[ -d "$d" ] || continue
	girar-repo-savetree "$src" "$dst"
	readlink -ev -- "$dst"
	# Move archived tasks to .done/.
	exec </dev/null >/dev/null 2>&1
	enable -f /usr/lib/bash/lockf lockf
	builtin lockf -n -s "$dst"
	# We are called while $repo/release is locked,
	# so $repo/release/latest cannot change.
	builtin lockf -n -s "$repo/release/latest"
	cd "$repo/task/"
	for t in $(set +f && echo [1-9]*); do
		[ -d "$t" ] || continue
		k="_$(($t/1024))" || continue
		ti="$t/files/list/task.info"
		[ -w "$ti" ] || continue
		ati="archive/$k/$t/files/list/task.info"
		# Has it been archived already?
		cmp -s -- "$ti" "$ati" || continue
		builtin lockf -n "$t" || continue
		mkdir -p -m755 .done
		chmod u+w "$t"
		mv "$t" .done/
		logger -t "$PROG" "done: $repo/task/$t"
	done
	exit
done

fatal "repo $repo: Invalid argument"
