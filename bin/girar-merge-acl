#!/bin/sh -efu
# Command format:
# <Target> <Action> <Arguments>
#
# <Target> := Package|@Group
# <Action> := add|del|leader|replace
#
# Superuser additional actions:
# <Action> := create|delete
#

. girar-sh-functions

. shell-error
. shell-quote

enable -f /usr/lib/bash/lockf lockf
builtin lockf -v "$GIRAR_ACL_CONF_DIR"
builtin lockf -v "$GIRAR_ACL_STATE_DIR"

workdir=
cleanup_handler()
{
	[ -z "$workdir" ] || rm -rf -- "$workdir"
	exit "$@"
}

trap 'cleanup_handler $?' EXIT
trap 'exit 143' HUP PIPE INT QUIT TERM
workdir="$(mktemp -dt "$PROG.XXXXXXXX")"
cd "$workdir"

mkdir -- list mails status

# Copy all active acl files to workdir.
find "$GIRAR_ACL_CONF_DIR" -type f -name 'list.*' \
	-exec cp -at list -- \{\} \+

# Save old acl files for later analysis.
cp -a list list.orig

# Handle new spooled acl files in ascending modification time order.
find "$GIRAR_ACL_STATE_DIR" -mindepth 2 -maxdepth 2 -type f \
	-newer "$GIRAR_ACL_STATE_DIR/.stamp" -name '*.acl' -printf '%T@\t%p\n' |
	sort |
	cut -f2 |
while read rulesfile; do

	person="${rulesfile##*/}"
	person="${person%.acl}"

	repository="${rulesfile%/*}"
	repository="${repository##*/}"

	logfile="status/$person.$repository."

	if GIRAR_USER="$person" girar-acl-apply-changes "$repository" list \
	   < "$rulesfile" > "$logfile" 2>&1; then
		# Install all working acl files as active.
		find list -type f -name 'list.*' \
			-exec cp -at "$GIRAR_ACL_CONF_DIR" -- \{\} \+
		newlogfile="${logfile}COMPLETE"
	else
		# Copy all active acl files to workdir.
		find "$GIRAR_ACL_CONF_DIR" -type f -name 'list.*' \
			-exec cp -at list -- \{\} \+
		newlogfile="${logfile}ABORTED"
	fi

	mv "$logfile" "$newlogfile"
	rm -f -- "$rulesfile"

	# Store information required for sending emails at the end of processing.
	printf '%s %s %s\n' "$person" "$repository" "$newlogfile" >>mails/info
done

# Update timestamp.
touch -- "$GIRAR_ACL_STATE_DIR"/.stamp
sleep 1

[ -s mails/info ] ||
	exit 0

rsync -rlt -- "$GIRAR_ACL_CONF_DIR/" "$GIRAR_ACL_PUB_DIR/"

while read person repository logfile; do
	status="${logfile##*.}"
	email="$(girar-get-email-address "$person")"
	cat >mails/msg <<EOF
From: Girar ACL robot <girar-acl@$EMAIL_DOMAIN>
To: $email
Cc: Girar ACL robot <girar-acl@$EMAIL_DOMAIN>
X-Incominger: acl
Subject: [girar-acl] $status $repository
Content-Type: text/plain; charset=us-ascii

Dear $(printf %s "$email" | sed -n 's/^"\([^"]\+\)".*/\1/p')!

Result of your acl command(s) is listed below:

EOF
	cat -- "$logfile" >>mails/msg
	cat >>mails/msg <<EOF

Summary: ACL change transaction $status.


-- 
Rgrds, your Girar ACL robot

EOF
	/usr/sbin/sendmail -i -t <mails/msg
done <mails/info

girar-acl-notify-changes list.orig "$GIRAR_ACL_CONF_DIR"
