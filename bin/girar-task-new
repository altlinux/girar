#!/bin/sh -efu

. girar-sh-functions
PROG='girar-task new'

usage()
{
	[ -z "$*" ] || message "$*"
	echo >&2 "usage: $PROG [binary package repository name]"
	exit 1
}

case "${1-}" in
	--help|help|'')
		usage ;;
esac

[ "$#" -le 1 ] ||
	usage 'Too many arguments.'

repo="${1-}"
[ -n "$repo" ] ||
	repo=sisyphus
fgrep -ixqse "$repo" "$GIRAR_REPOSITORIES" ||
	fatal "invalid repository \`$repo', valid repositories are: $(tr -s '[:space:]' ' '<"$GIRAR_REPOSITORIES")"

enable -f /usr/lib/bash/lockf lockf
builtin lockf -v .

id=$(cat .max-task-id)
id=$(($id+1))

trap '' HUP INT QUIT PIPE TERM
echo "$id" >.max-task-id
mkdir "$id"

builtin lockf -v "$id"
mkdir "$id"/task
echo "$id" >"$id"/task/id
echo "$GIRAR_USER" >"$id"/task/owner
echo "$repo" >"$id"/task/repo

echo >&2 "new task id=$id owner=$GIRAR_USER repo=$repo"
