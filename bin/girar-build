#!/bin/sh -efu

. girar-sh-functions

usage()
{
	echo >&2 "$PROG: $*"
	echo >&2 "usage: $PROG <path to git repository> <tag name> <binary package repository name> [<project name>]"
	exit 1
}

[ "${1-}" != '--help' ] ||
	usage
[ "$#" -ge 3 ] ||
	usage 'Not enough arguments.'
[ "$#" -le 4 ] ||
	usage 'Too many arguments.'
[ -n "${GIRAR_USER:-}" ] || 
	fatal "GIRAR_USER undefined"

dir="$1"; shift
tag="$1"; shift
repo="$1"; shift

id="$(girar-task new "$repo")"
girar-task add "$id" "$dir" "$tag" "$repo" "$@" &&
girar-task run "$id" ||
{
	girar-task drop "$id"
	exit 1
}
