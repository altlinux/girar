#!/bin/sh -efu

. girar-sh-functions

input_queue="$GIRAR_PUBLIC_QUEUE"
our_queue="$GIRAR_PRIVATE_QUEUE"
remote_queue="$UPRAVDOM_QUEUE"
remote_account="$UPRAVDOM_ACCOUNT"

find_args="-mindepth 1 -maxdepth 1 -regextype posix-basic -regex '^.*/[[:digit:]]\+$' -type f -printf '%f\n'"

findin()
{
	eval find "\$1" $find_args |
		sort -n
}

enable -f /usr/lib/bash/lockf lockf
builtin lockf -v "$our_queue"
builtin lockf -v "$input_queue"

# move tasks from input queue to our queue
for name in $(findin "$input_queue"); do
	task="$input_queue/$name"

	[ -s "$task" ] && cat "$task" >/dev/null ||
	{
		rm -f -- "$task"
		continue
	}

	mv -- "$task" "$our_queue/" ||
	{
		message "$name: unable to move task"
		continue
	}
done

# exit if our queue is empty
[ -n "$(findin "$our_queue")" ] || exit 0

# move tasks from our queue to remote queue
for name in $(findin "$our_queue"); do
	rsync --rsync-path="enable -f /usr/lib/bash/lockf lockf && builtin lockf $remote_queue && rsync" \
	      -rt "$our_queue/$name" "$remote_account:$remote_queue/" ||
		fatal "$name: unable to forward task: rc=$?"
	rm -f -- "$our_queue/$name"
done
