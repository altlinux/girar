#!/bin/sh -efu

. girar-sh-functions
PROG='girar-task run'

usage()
{
	[ -z "$*" ] || message "$*"
	echo >&2 "usage: $PROG [<task id>]"
	exit 1
}

if [ "${1-}" = '--help' ]; then
	usage
fi

if [ "$#" -gt 1 ]; then
	usage 'Too many arguments.'
fi

cd "$GB_TASKS"
id="$(PROG="$PROG" girar-task-find-current "$@")"

cd "$id"
enable -f /usr/lib/bash/lockf lockf
builtin lockf -v .

[ -s gears/1/dir ] ||
	fatal "cannot run empty task #$id"

seq=
if [ -f task/seq ]; then
	seq=$(cat task/seq)
	case "$(($seq%3))" in
		# awaiting for build
		0) fatal "task #$id already scheduled for run" ;;
		# work in progress
		1) fatal "task #$id is a work in progress" ;;
		# have build results
		2) seq=$(($seq+1))
	esac
else
	seq=0
fi

trap '' HUP INT QUIT PIPE TERM
echo "$seq" >task/seq

echo >&2 "task $id seq=$seq"
