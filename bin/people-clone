#!/bin/sh -e

fatal()
{
	echo "${0##*/}: $*" >&2
	exit 1
}

usage()
{
	echo "${0##*/}: $*" >&2
	echo "usage: ${0##*/} <repository> [<directory>]" >&2
	exit 1
}

[ "$#" -ge 1 ] ||
	usage 'Not enough arguments.'
[ "$#" -le 2 ] ||
	usage 'Too many arguments.'

[ -n "$USER" ] ||
	fatal 'USER undefined'

cd "/people/${USER#git_}/packages"

repo0="$1" && shift
repo=
if [ -e "$repo0" ]; then
	repo="$(readlink -ev "$repo0")/"
	people="$(readlink -ev /people)"
	[ -z "${repo##$people/*}" ] ||
		fatal "$repo0: invalid local repository"
fi
if [ -z "$repo" ]; then
	case "$repo0" in
		rsync://*|https://*|http://*) ;;
		*) fatal "$repo0: invalid repository" ;;
	esac
fi

if [ "$#" -ge 1 ]; then
	dir0="$1" && shift
else
	dir0="${repo0##*/}"
fi

dir="$(printf %s "$dir0" |sed -e 's,^packages/,,' -e 's,/\+$,,' -e 's,\.git$,,')"
printf %s "$dir" |egrep -qs '^[A-Za-z0-9][-A-Za-z0-9_.]+$' ||
	fatal "$dir0: invalid directory name"
[ ! -e "$dir".git ] ||
	fatal "$dir0: destination already exists"

git-clone --bare --template=/etc/giter/templates/packages "$repo0" "$dir.git"
echo "packages/$dir" >"$dir".git/description
umask 027
touch "$dir".git/mailto
