#!/bin/sh -efu

PROG=git-ls

fatal()
{
	echo "$PROG: $*" >&2
	exit 1
}

usage()
{
	echo "$PROG: $*" >&2
	echo "usage: $PROG [<directory>]" >&2
	exit 1
}

[ "$#" -le 1 ] ||
	usage 'Too many arguments.'

[ -n "${GITER_HOME:-}" ] ||
	fatal 'GITER_HOME undefined'

cd

if [ "$#" -ge 1 ]; then
	dir="$1" && shift
	printf %s "$dir" |egrep -qs '^[A-Za-z0-9/][-A-Za-z0-9_./]+$' ||
		fatal "$dir: invalid directory name"
else
	dir=.
fi

[ -d "$dir" ] ||
	fatal "$dir: directory not available"

[ -z "${dir%%*/}" ] || dir="$dir/"
[ -n "${dir##/*}" -o -z "${dir##$GITER_HOME/*}" ] ||
	fatal "$dir: invalid directory name"
d="$(readlink -e "$dir")/" ||
	fatal "$dir: directory not available"
p="$(readlink -e "$GITER_HOME")" ||
	fatal "$dir: directory not available"
[ -z "${d##$p/*}" ] ||
	fatal "$dir: invalid directory name"

exec ls -log -- "$dir"
